from flask import Blueprint, request, jsonify
from sqlalchemy.orm import sessionmaker
from sqlalchemy import create_engine

from connection.connection import get_database
from src.controller.demo import Demo
from src.controller.demo_model import DemoModel

demo_controller = Blueprint('demo_controller', __name__, url_prefix="/demos")

database = get_database()
DATABASE_URL = (
    f"mysql+pymysql://{database['user']}:{database['password']}"
    f"@{database['host']}:{database['port']}/{database['database']}"
)

engine = create_engine(DATABASE_URL, echo=False)
SessionLocal = sessionmaker(bind=engine)

class DemoController:

    @staticmethod
    @demo_controller.get("/")
    def get_all():
        session = SessionLocal()
        demos = session.query(DemoModel).all()
        session.close()

        result = [Demo(id_=d.id, name=d.name) for d in demos]
        return jsonify(result), 200

    @staticmethod
    @demo_controller.get("/<int:id_>")
    def get_by_id(id_):
        session = SessionLocal()
        demo = session.query(DemoModel).filter_by(id=id_).first()
        session.close()

        if not demo:
            return jsonify({"error": "Demo not found"}), 404

        return jsonify(Demo(id_=demo.id, name=demo.name)), 200

    @staticmethod
    @demo_controller.post("/")
    def create():
        data = request.get_json()

        if not data or "name" not in data:
            return jsonify({"error": "Missing 'name' field"}), 400

        session = SessionLocal()

        demo = DemoModel(name=data["name"])
        session.add(demo)
        session.commit()
        session.refresh(demo)
        session.close()

        return jsonify(Demo(id_=demo.id, name=demo.name)), 201

    @staticmethod
    @demo_controller.put("/<int:id_>")
    def update(id_):
        data = request.get_json()

        if not data:
            return jsonify({"error": "Missing JSON body"}), 400

        session = SessionLocal()
        demo = session.query(DemoModel).filter_by(id=id_).first()

        if not demo:
            session.close()
            return jsonify({"error": "Demo not found"}), 404

        if "name" in data:
            demo.name = data["name"]

        session.commit()
        session.refresh(demo)
        session.close()

        return jsonify(Demo(id_=demo.id, name=demo.name)), 200

    @staticmethod
    @demo_controller.delete("/<int:id_>")
    def delete(id_):
        session = SessionLocal()
        demo = session.query(DemoModel).filter_by(id=id_).first()

        if not demo:
            session.close()
            return jsonify({"error": "Demo not found"}), 404

        session.delete(demo)
        session.commit()
        session.close()

        return jsonify({"message": "Deleted successfully"}), 200
